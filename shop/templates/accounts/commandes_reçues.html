{% extends "shop/base.html" %}
{% block content %}
<h2 class="mb-4">Commandes reÃ§ues pour mes produits</h2>
{% with total=lignes|length %}
  <div class="alert alert-info">
    Nombre total de commandes reÃ§ues : <strong>{{ total }}</strong>
  </div>
{% endwith %}

<!-- Filtre par statut -->
<form method="get" class="mb-3">
  <label for="statut">Filtrer par statut :</label>
  <select name="statut" id="statut" onchange="this.form.submit()">
    <option value="">Tous</option>
    <option value="payee" {% if request.GET.statut == "payee" %}selected{% endif %}>PayÃ©e</option>
    <option value="nonpayee" {% if request.GET.statut == "nonpayee" %}selected{% endif %}>Non payÃ©e</option>
  </select>
</form>

<a href="{% url 'export_commandes_reÃ§ues' %}" class="btn btn-outline-success mb-3">
  ğŸ“¥ Exporter en CSV
</a>
<a href="{% url 'export_commandes_reÃ§ues_pdf' %}?statut={{ request.GET.statut }}" class="btn btn-outline-danger mb-3 ml-2">
  ğŸ“„ Exporter en PDF
</a>

<table class="table table-striped table-hover">
  <thead class="thead-dark">
    <tr>
      <th>Produit</th>
      <th>Client</th>
      <th>Email</th>
      <th>QuantitÃ©</th>
      <th>Montant</th>
      <th>Date</th>
      <th>Statut</th>
      <th>Contact</th>
    </tr>
  </thead>
  <tbody>
    {% for ligne in lignes %}
      {% if request.GET.statut == "payee" and not ligne.commande.paye %}
        {# On saute cette ligne #}
      {% elif request.GET.statut == "nonpayee" and ligne.commande.paye %}
        {# On saute cette ligne #}
      {% else %}
    <tr>
      <td>
        <a href="{% url 'detail' myid=ligne.produit.id %}">
          {% if ligne.produit.image %}
            <img src="{{ ligne.produit.image.url }}" alt="{{ ligne.produit.nom }}" width="40" class="mr-2 rounded" />
          {% endif %}
          {{ ligne.produit.nom }}
        </a>
      </td>
      <td>
        {% if ligne.commande.utilisateur %}
          <span class="badge badge-info">{{ ligne.commande.utilisateur.username }}</span>
        {% else %}
          {{ ligne.commande.nom }}
        {% endif %}
      </td>
      <td>
        {% if ligne.commande.utilisateur %}
          <a href="mailto:{{ ligne.commande.utilisateur.email }}">{{ ligne.commande.utilisateur.email }}</a>
        {% else %}
          <a href="mailto:{{ ligne.commande.email }}">{{ ligne.commande.email }}</a>
        {% endif %}
      </td>
      <td><span class="badge badge-primary">{{ ligne.quantite }}</span></td>
      <td>
        <span class="badge badge-success">
          {{ ligne.quantite }} Ã— {{ ligne.prix_unitaire }} FCFA = {{ ligne.montant_total }} FCFA
        </span>
      </td>
      <td>{{ ligne.commande.date_commande|date:"d/m/Y H:i" }}</td>
      <td>
        {% if ligne.commande.paye %}
          <span class="badge badge-success">PayÃ©e</span>
        {% else %}
          <span class="badge badge-warning">Non payÃ©e</span>
        {% endif %}
      </td>
      <td>
        {% if ligne.commande.utilisateur %}
          <a href="mailto:{{ ligne.commande.utilisateur.email }}" class="btn btn-sm btn-outline-primary">Contacter</a>
        {% else %}
          <a href="mailto:{{ ligne.commande.email }}" class="btn btn-sm btn-outline-primary">Contacter</a>
        {% endif %}
      </td>
    </tr>
      {% endif %}
    {% empty %}
    <tr>
      <td colspan="8" class="text-center text-muted">Aucune commande reÃ§ue.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}