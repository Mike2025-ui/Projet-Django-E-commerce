{% extends "shop/base.html" %}
{% load static %}
{% block content %}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
/>

<div class="container py-4">
  <!-- Messages flash -->
  {% if messages %}
  <div class="mb-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Bandeau utilisateur -->
  <div class="row mb-4 align-items-center">
    <div class="col-md-8">
      <h2 class="mb-0">üëã Bienvenue, <strong>{{ user.username }}</strong></h2>
      <p class="text-muted">
        Statut :
        <span
          class="badge badge-pill {% if user.is_superuser %}badge-danger{% else %}badge-primary{% endif %}"
        >
          {% if user.is_superuser %}Administrateur{% else %}Utilisateur{% endif %}
        </span>
      </p>
    </div>
    <div class="col-md-4 text-md-right">
      <!-- Affichage de la photo de profil -->
      {% if user.photo %}
      <img
        src="{{ user.photo.url }}"
        alt="Photo de profil"
        class="rounded-circle mb-3"
        width="100"
        height="100"
        id="photo-profil"
      />
      {% else %}
      <img
        src="{% static 'default-avatar.png' %}"
        alt="Photo de profil"
        class="rounded-circle mb-3"
        width="100"
        height="100"
        id="photo-profil"
      />
      {% endif %}
    </div>
    <div class="card shadow-sm mb-4 w-100">
      <div class="card-header bg-light font-weight-bold">
        Modifier ma photo de profil
      </div>
      <div class="card-body">
        <form
          method="POST"
          enctype="multipart/form-data"
          action="{% url 'modifier_photo_profil' %}"
        >
          {% csrf_token %}
          <div class="form-group">
            <label for="id_photo">Nouvelle photo</label>
            <input
              type="file"
              name="photo"
              id="id_photo"
              class="form-control-file"
              accept="image/*"
              required
            />
            <br>
            <img id="preview-photo" src="#" alt="Aper√ßu" style="display:none;max-width:100px;max-height:100px;border-radius:8px;border:1px solid #ccc;" />
          </div>
          <button class="btn btn-primary" type="submit">Mettre √† jour</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Formulaire ajout ou modification produit -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light font-weight-bold">
      {% if request.GET.edit %}Modifier un produit{% else %}Ajouter un nouveau produit{% endif %}
    </div>
    <div class="card-body">
      <form method="POST" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <div class="form-group">
          {{ form.photo.label_tag }} {{ form.photo }}
          {% for error in form.photo.errors %}
          <div class="text-danger">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="form-group">
          {{ form.nom.label_tag }} {{ form.nom }}
          {% for error in form.nom.errors %}
          <div class="text-danger">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="form-group">
          {{ form.description.label_tag }} {{ form.description }}
          {% for error in form.description.errors %}
          <div class="text-danger">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="form-group">
          {{ form.prix.label_tag }} {{ form.prix }}
          {% for error in form.prix.errors %}
          <div class="text-danger">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="form-group">
          {{ form.category.label_tag }} {{ form.category }}
          {% for error in form.category.errors %}
          <div class="text-danger">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="form-group">
          {{ form.image.label_tag }} {{ form.image }}
          {% for error in form.image.errors %}
          <div class="text-danger">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="form-group">
          {{ form.image_url.label_tag }} {{ form.image_url }}
          {% for error in form.image_url.errors %}
          <div class="text-danger">{{ error }}</div>
          {% endfor %}
        </div>

        <!-- Pr√©visualisation de l‚Äôimage -->
        <div class="form-group">
          <label>Pr√©visualisation de l'image : </label><br />
          <img
            id="preview"
            src="#"
            alt="Aper√ßu de l'image"
            style="max-height: 150px; display: none"
            class="border rounded p-1"
          />
        </div>

        <button class="btn btn-success">
          {% if request.GET.edit %}Mettre √† jour{% else %}Ajouter{% endif %}
        </button>
      </form>
    </div>
  </div>

  <!-- Produits de l'utilisateur -->
  <h4 class="mb-3">üõçÔ∏è Mes produits</h4>
  <div class="row">
    {% for p in mes_produits %}
    <div class="col-md-3">
      <div class="card shadow-sm mb-3 h-100">
        <img src="{{ p.get_image }}" class="card-img-top" alt="Image produit" />
        <div class="card-body">
          <h5 class="card-title">{{ p.nom }}</h5>
          <p class="card-text text-muted">{{ p.prix }} FCFA</p>
          <a
            href="{% url 'dashboard' %}?edit={{ p.pk }}"
            class="btn btn-sm btn-warning"
            >‚úèÔ∏è Modifier</a
          >
          <a
            href="{% url 'supprimer_produit' p.pk %}"
            class="btn btn-sm btn-danger"
            >üóëÔ∏è Supprimer</a
          >
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <p class="text-muted">Pas encore de produit ajout√©.</p>
    </div>
    {% endfor %}
  </div>

  <!-- Tous les produits -->
  <div class="row">
    {% for p in produits_globaux %}
    <div class="col-md-3">
      <div class="card shadow-sm mb-3 h-100">
        <img src="{{ p.get_image }}" class="card-img-top" alt="Image produit" />
        <div class="card-body">
          <h5 class="card-title">{{ p.nom }}</h5>
          <p class="card-text text-muted">{{ p.prix }} FCFA</p>
          <a href="{% url 'detail' myid=p.pk %}" class="btn btn-sm btn-success"
            >üõí Voir / Commander</a
          >
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="text-center mt-4">
    <a
      href="{% url 'commandes_re√ßues' %}"
      style="align-items: center"
      class="btn btn-info"
      >Voir les commandes re√ßues</a
    >
    {% if user.is_superuser %}
    <a href="{% url 'commandes_utilisateurs' %}" class="btn btn-info"
      >Voir toutes les commandes</a
    >
    {% endif %}
  </div>
</div>
{% endblock %}

{% block js %}
<script>
  // Pr√©visualisation de la photo de profil avant envoi
  document.getElementById("id_photo")?.addEventListener("change", function (e) {
    const file = e.target.files[0];
    const preview = document.getElementById("preview-photo");
    if (file && preview) {
      const reader = new FileReader();
      reader.onload = function (event) {
        preview.src = event.target.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(file);
    } else if (preview) {
      preview.src = "#";
      preview.style.display = "none";
    }
  });

  // Pr√©visualisation de l'image locale pour les produits
  document
    .querySelector('input[type="file"][name="image"]')
    ?.addEventListener("change", function (e) {
      const file = e.target.files[0];
      const preview = document.getElementById("preview");
      if (file && preview) {
        const reader = new FileReader();
        reader.onload = function (event) {
          preview.src = event.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    });

  // Pr√©visualisation de l'image en ligne pour les produits
  document
    .querySelector('input[type="url"]')
    ?.addEventListener("input", function (e) {
      const url = e.target.value;
      const preview = document.getElementById("preview");
      if (url && preview) {
        preview.src = url;
        preview.style.display = "block";
      }
    });
</script>
{% endblock %}