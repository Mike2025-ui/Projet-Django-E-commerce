{% extends 'shop/base.html' %} {% block content %}
<style>
  div {
    background-color: #f8f9fa;
  }
  .zoom-hover {
    transition: transform 0.3s ease;
  }
  .zoom-hover:hover {
    transform: scale(1.1);
  }

  #toast {
    visibility: hidden;
    min-width: 250px;
    background-color: #28a745;
    color: white;
    text-align: center;
    border-radius: 5px;
    padding: 16px;
    position: fixed;
    bottom: 30px;
    right: 30px;
    font-size: 17px;
    z-index: 1050;
    opacity: 0;
    transition: opacity 0.5s ease-in-out, visibility 0.5s;
  }

  #toast.show {
    visibility: visible;
    opacity: 1;
  }

  .star-rating {
    display: inline-block;
    direction: rtl;
    font-size: 24px;
  }

  .star-rating input[type="radio"] {
    display: none;
  }

  .star-rating label {
    color: #ccc;
    cursor: pointer;
  }

  .star-rating input[type="radio"]:checked ~ label,
  .star-rating label:hover,
  .star-rating label:hover ~ label {
    color: gold;
  }
</style>

<div class="row">
  <div class="col-md-6">
    <div>
      {% if product.image %}
      <img
        src="{{ product.image.url }}"
        alt="{{ product.nom }}"
        class="img-fluid zoom-hover"
      />
      {% elif product.image_url %}
      <img
        src="{{ product.image_url }}"
        alt="{{ product.nom }}"
        class="img-fluid zoom-hover"
      />
      {% else %}
      <img
        src="https://via.placeholder.com/300x200?text=Pas+d'image"
        class="img-fluid zoom-hover"
        alt="Pas d'image"
      />
      {% endif %}
    </div>
  </div>

  <div class="col-md-6">
    <div id="nom-produit" class="text-warning display-3">{{ product.nom }}</div>

    <div id="prix-produit" style="color: rgb(204, 61, 9); font-weight: bold">
      Prix : {{ product.prix }} FCFA
    </div>

    <div class="mt-3">{{ product.description }}</div>
    <div class="d-flex align-items-center mt-4">
      <button
        onclick="ajouterEtCommander('{{ product.id }}')"
        class="btn btn-success mr-3"
      >
        Acheter
      </button>
      <a href="{% url 'index' %}" class="btn btn-secondary">Retour</a>
    </div>
  </div>
</div>
<div>
  <h3>Avis des clients</h3>
  {% for review in product.reviews.all %}
  <div style="border: 1px solid #ccc; margin-bottom: 10px; padding: 10px">
    <strong>{{ review.user.username }}</strong>
    <span>
      {% for i in "12345"|slice:":review.note"|make_list %}
      <span style="color: gold">&#9733;</span>
      {% endfor %} {% for i in "12345"|slice:"review.note:"|make_list %}
      <span style="color: #ccc">&#9733;</span>
      {% endfor %} </span
    ><br />
    <small>Posté le {{ review.date_added }}</small>
    <p>{{ review.commentaire }}</p>
  </div>
  {% empty %}
  <p>Aucun avis pour ce produit.</p>
  {% endfor %} {% if user.is_authenticated %}
  <form method="post">
    {% csrf_token %}
    <label>Note :</label>
    <div class="star-rating">
      <input type="radio" name="note" value="5" id="note-5" required /><label
        for="note-5"
        >&#9733;</label
      >
      <input type="radio" name="note" value="4" id="note-4" /><label
        for="note-4"
        >&#9733;</label
      >
      <input type="radio" name="note" value="3" id="note-3" /><label
        for="note-3"
        >&#9733;</label
      >
      <input type="radio" name="note" value="2" id="note-2" /><label
        for="note-2"
        >&#9733;</label
      >
      <input type="radio" name="note" value="1" id="note-1" /><label
        for="note-1"
        >&#9733;</label
      >
    </div>
    <br /><br />
    <label>Commentaire :</label><br />
    <textarea name="commentaire" rows="4" cols="40" required></textarea><br />
    <button type="submit" style="background-color: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px;">Envoyer l'avis</button>
  </form>
  {% else %}
  <p><a href="{% url 'login' %}">Connectez-vous</a> pour laisser un avis.</p>
  {% endif %}
</div>
{% endblock %} {% block js %}
<script type="text/javascript">
  let panier = localStorage.getItem("panier")
    ? JSON.parse(localStorage.getItem("panier"))
    : {};

  function updateBadge() {
    const compteur = Object.values(panier).reduce((a, b) => a + b[0], 0);
    $("#compteur-panier").text(compteur);
  }
  updateBadge();

  function ajouterAuPanier(id, nom, prix) {
    if (panier[id]) {
      panier[id][0] += 1;
      panier[id][2] += prix;
    } else {
      panier[id] = [1, nom, prix];
    }
    localStorage.setItem("panier", JSON.stringify(panier));
    updateBadge();
  }

  function showToast(message) {
    let toast = document.getElementById("toast");
    if (!toast) {
      toast = document.createElement("div");
      toast.id = "toast";
      document.body.appendChild(toast);
    }
    toast.textContent = message;
    toast.classList.add("show");
    setTimeout(() => {
      toast.classList.remove("show");
    }, 2000);
  }

  function ajouterEtCommander(id) {
    const nom = document.getElementById("nom-produit").textContent.trim();
    const prixTexte = document.getElementById("prix-produit").textContent;
    const prix = parseInt(
      prixTexte.replace("Prix :", "").replace("FCFA", "").trim()
    );

    ajouterAuPanier(id, nom, prix);

    showToast(`Produit "${nom}" ajouté au panier !`);
    setTimeout(() => {
      window.location.href = "{% url 'detail' myid=product.id %}";
    }, 1000);
  }
</script>
{% endblock %}
